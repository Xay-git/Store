<% layout("/common/_container.html"){ %><link rel="stylesheet" href="/modular/css/cashier.css" media="all"><style>    .layui-table-cell {        height: inherit;    }    .user-info-head {        width: 110px;        height: 110px;        position: relative;        display: inline-block;    }    .user-info-head:hover:after {        content: '\e65d';        position: absolute;        left: 0;        right: 0;        top: 0;        bottom: 0;        color: #eee;        background: rgba(0, 0, 0, 0.5);        font-family: layui-icon;        font-size: 24px;        font-style: normal;        -webkit-font-smoothing: antialiased;        -moz-osx-font-smoothing: grayscale;        cursor: pointer;        line-height: 110px;        border-radius: 50%;    }    .user-info-head img {        width: 110px;        height: 110px;        border-radius: 50%;    }</style><div class="layui-body-header">    <span class="layui-body-header-title">添加</span></div><div class="">    <div class="layui-card">        <div id="memberapp" class="layui-card-body" style="padding:20px;padding-bottom:80px ">            <blockquote class="layui-elem-quote layui-quote-nm">个人资料</blockquote>            <form id="memberForm" lay-filter="memberForm" class="layui-form model-form">                <div class="layui-row layui-col-space15">                    <div class="layui-col-md2">                        <div class="text-center layui-text">                            <div class="user-info-head" id="imgHead">                                <img id="avatarPreview" src="/common/images/default.jpg">                            </div>                            <input id="avatar" type="hidden" name="avatar">                            <h3 style="padding-top:30px;color: #666666;">设置头像</h3>                        </div>                    </div>                    <div class="layui-col-md5">                        <input type="hidden" name="id">                        <div class="layui-form-item">                            <label class="layui-form-label">姓名<span style="color: red;">*</span> </label>                            <div class="layui-input-block">                                <input id="name" name="name" placeholder="请输入姓名" type="text" class="layui-input"                                       lay-verify="required|"/>                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">手机号<span style="color: red;">*</span> </label>                            <div class="layui-input-block">                                <input id="phoneNumber" name="phoneNumber" placeholder="请输入手机号" type="text"                                       class="layui-input" lay-verify="required|phone|"/>                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">性别</label>                            <div class="layui-input-block">                                <input type="radio" name="sex" value="1" title="男" checked>                                <input type="radio" name="sex" value="2" title="女">                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">出生年月</label>                            <div class="layui-input-block">                                <input id="birthday" name="birthday" readonly="readonly" placeholder="请输入出生年月"                                       autocomplete="off" type="text" class="layui-input" lay-verify="" lay-key="3">                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">客户来源</label>                            <div class="layui-input-block">                                <el-select v-model="data.comeFrom">                                    <el-option                                            v-for="item in comeFromDic"                                            :key="item.dictId"                                            :label="item.name"                                            :value="item.dictId"                                    >                                    </el-option>                                </el-select>                                <input type="hidden" name="comeFrom" v-model="data.comeFrom">                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">家庭住址</label>                            <div class="layui-input-block">                                <textarea name="address" placeholder="请输入家庭住址" class="layui-textarea"                                          lay-verify=""></textarea>                            </div>                        </div>                    </div>                    <div class="layui-col-md5">                        <div class="layui-form-item">                            <label class="layui-form-label">所属门店</label>                            <div class="layui-input-block">                                <el-select v-model="data.deptId">                                    <el-option                                            v-for="item in deptList"                                            :key="item.deptId"                                            :label="item.deptName"                                            :value="item.deptId"                                    >                                    </el-option>                                </el-select>                                <input type="hidden" name="deptId" v-model="data.deptId">                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">短信提醒</label>                            <div class="layui-input-block">                                <input type="checkbox" name="smsAlert" checked lay-skin="switch" lay-text="开启|关闭">                            </div>                        </div>                        <div class="layui-form-item">                            <label class="layui-form-label">备注</label>                            <div class="layui-input-block">                                <textarea name="remark" placeholder="请输入备注" class="layui-textarea"                                          lay-verify=""></textarea>                            </div>                        </div>                        <div class="layui-input-block" style="text-align: left;margin-top: 80px;">                            <button class="layui-btn btn-color" lay-filter="btnSubmit" type="button" lay-submit>&emsp;修改&emsp;</button>                        </div>                    </div>                </div>            </form>            <hr/>            <el-tabs v-model="activeName" @tab-click="handleClick">                <el-tab-pane label="卡券信息" name="first">                    <div style="height: 330px;overflow-y: scroll;">                        <el-table                                :data="memberCardList"                                style="width: 100%">                            <el-table-column                                    prop="name"                                    label="卡类型"                                    width="180">                            </el-table-column>                            <el-table-column                                    prop="amount"                                    label="余额"                                    width="180">                            </el-table-column>                            <el-table-column                                    prop="projectDiscount"                                    label="项目折扣">                            </el-table-column>                            <el-table-column                                    prop="goodDiscount"                                    label="商品折扣">                            </el-table-column>                            <el-table-column                                    prop="createTime"                                    label="开卡时间">                            </el-table-column>                        </el-table>                    </div>                </el-tab-pane>                <el-tab-pane label="消费记录" name="second">                    <table class="layui-table" id="sellTable" lay-filter="sellTable"></table>                </el-tab-pane>            </el-tabs>        </div>    </div></div><script>    var form = layui.form;    var $ = layui.jquery;    var upload = layui.upload;    var PREFIX = '/admin/member';    var initColumn = [[        // {type: 'checkbox'},        {field: 'id', title: '', hide: true},        {field: 'sellAmount', title: '消费金额', width: 90},        {field: 'realAmount', title: '实际入账', width: 90},        {            field: 'sellType', title: '消费类型', templet(d) {                if (d.sellType == 1) {                    return "开卡";                }                if (d.sellType == 2) {                    return "续卡";                }                if (d.sellType == 3) {                    return "卖品/项目";                }            }, width: 100        },        {            title: '销售详情', width: 320, templet(d) {                var html = '';                for (let item of d.selldetailList) {                    html += "消费项目:" + item.name + "<br/>"                        + "原价:" + item.amount                        + "&nbsp;|&nbsp;实收:" + item.realAmount + ""                        + "&nbsp;|&nbsp;服务人员:<br/>"                    for (let thce of item.selldetailTechList) {                        console.log("1__" + thce.techName)                        html += "" + thce.techName + "<br/>"                    }                }                return html;            }        },        {            title: '支付方式', width: 240, templet(d) {                var html = '';                for (let item of d.sellpayList) {                    html += "支付方式:" + "<span>" + item.payName                        + "&nbsp;|&nbsp;支付金额:" + item.amount + "<br/>"                }                return html;            }        },        {            field: 'status', title: '状态', templet(d) {                if (d.status == 1) {                    return '正常'                } else if (d.status == 2) {                    return '<span style="color:red">已销单</span>'                }            }, width: 90        },        {field: 'createTime', title: '消费时间'},        // {align: 'center', toolbar: '#tableBar', title: '操作' }    ]];    var vm = new Vue({        el: '#memberapp',        data: {            msg: 'Hello World!',            deptList: '',            comeFromDic: '',            data: {                deptId: '',                comeFrom: api.dictDetail.comfrom            },            loginUser: '',            activeName: 'first',            memberCardList: [],            result: ''        },        methods: {            handleClick(tab, event) {                console.log(tab, event);            },            getDetail: async function (id) {                vm.data = await request.fetch(PREFIX + '/getMemberDetail', {id: id});                form.val('memberForm', vm.data);            },            onload: async function () {                this.loginUser = await api.getLoginUser();                this.deptList = await api.getDeptList();                this.comeFromDic = await api.getDictDetail(api.dict.comefrom);                if (app.isEmpty(this.data.deptId)) {                    this.data.deptId = this.loginUser.deptId;                }            },            getMemberCardList() {                request.fetch("/admin/member/getMemberCardList", {memberId: vm.data.id}).then(res => {                    vm.memberCardList = res                })            },        },        mounted: async function () {            //在模板渲染成html后调用，通常是初始化页面完成后，再对html的dom节点进行一些需要的操作。            vm = this;            await vm.onload();            var id = app.getUrlParam('id');            app.isNotEmpty(id) && await vm.getDetail(id);            vm.getMemberCardList();            //表单提交事件            form.on('submit(btnSubmit)', function (data) {                console.log(data.field)                var dataSet = data.elem.dataset.sub;                var iframe = $("#iframe1", window.parent.document);                request.post(PREFIX + '/editMember', data.field).then(res => {                    app.success("操作成功！");                    if (dataSet == 'product' | dataSet == 'charged') {                        //跳转tab                        var parent = window.parent;                        parent.vm.activeIndex = 1;                        var iframe = $("#iframe1", window.parent.document)[0].contentWindow;                        iframe.vm.member = res;                        if (dataSet == 'product') {                            iframe.vm.selectIndex = 0;                        } else {                            iframe.vm.selectIndex = 1;                        }                        location.reload();                    } else {                        location.reload();                    }                })                return false;            })            laydate.render({                elem: '#birthday'            });            table.render({                elem: '#sellTable',                url: '/admin/sell/getSellList',                page: false,                height: "330",                cellMinWidth: 100,                cols: initColumn,                where: {                    memberId: vm.data.id,                },                done: function (res, curr, count) {                    console.log('返回数据的个数' + count);                    vm.result.total = count;                    //如果是异步请求数据方式，res即为你接口返回的信息。                    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度                    console.log(res);                    var data = res.data;                    var totalMoney = 0;                    var cardpay = 0;                    var cashpay = 0;                    var unionpay = 0;                    var alipay = 0;                    var wxpay = 0;                    var otherpay = 0;                    var discountpay = 0;                    var cardPay = 0;                    for (let item of data) {                        totalMoney = app.accAdd(item.sellAmount, totalMoney);                        var sellpayList = item.sellpayList;                        for (let pay of sellpayList) {                            console.log(pay)                            var payType = pay.payType;                            if (payType == 0) {                                cardpay = app.accAdd(pay.amount, cardpay);                            } else if (payType == 1) {                                cashpay = app.accAdd(pay.amount, cashpay);                            } else if (payType == 2) {                                unionpay = app.accAdd(pay.amount, unionpay);                            } else if (payType == 3) {                                alipay = app.accAdd(pay.amount, alipay);                            } else if (payType == 4) {                                wxpay = app.accAdd(pay.amount, wxpay);                            } else if (payType == 5) {                                otherpay = app.accAdd(pay.amount, otherpay);                            } else if (payType == 6) {                                discountpay = app.accAdd(pay.amount, discountpay);                            }                        }                    }                    console.log("合计金额" + totalMoney);                    vm.result.totalMoney = totalMoney;                    vm.result.cardpay = cardpay;                    vm.result.cashpay = cashpay;                    vm.result.unionpay = unionpay;                    vm.result.alipay = alipay;                    vm.result.wxpay = wxpay;                    vm.result.otherpay = otherpay;                    vm.result.discountpay = discountpay;                    //得到当前页码                    console.log(curr);                    //得到数据总量                    console.log(count);                }            });            form.render();        },        updated: function () {            form.render();        },        watch: {}    });</script><% } %>