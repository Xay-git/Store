<%layout("/common/_container.html"){%><style>    font{        position: absolute;        bottom: 100px;        left: 300px;    }</style><link rel="stylesheet" href="/modular/css/cashier.css" media="all"><script src='/modular/js/LodopFuncs.js'></script><div id="app" >    <div class="layui-card main" style="min-height:calc(90vh - 10px)">        <!--            搜索框-->        <div class="layui-form-item" style="padding-top: 20px;">            <label class="layui-form-label">客户查询</label>            <div class="layui-input-inline">                <smart-input  v-bind="result" placeholder="客户姓名/手机号" v-on:search="search"  v-on:data="getItem"></smart-input>            </div>        </div>        <div v-show="member.id">            <!--            会员详情-->            <div class="layui-row" style="height: 170px;">                <div class="layui-col-md5 ml" style="border-top: 1px solid #e0e2e9;">                    <div class="flexcenter" style="width: 30%;" >                        <img src="/common/images/default.jpg"/>                    </div>                    <div class="ml1" style="width: 70%;color: #444444;" >                        <div>                            <p style="font-size: 20px;margin-top: 15px;">{{member.name}}<span style="font-size: 14px;">[{{member.sex==1?'先生':'女士'}}]</span></p>                            <p style="border-bottom: 1px dashed #eee"><i class="layui-icon layui-icon-cellphone"> {{member.phoneNumber}}</i></p>                        </div>                        <div class="card">                            <div v-if="memberCard.id">                                <h2><b class="blue">折扣卡</b> <span style="margin-left: 10px;">{{memberCard.name}}</span>                                    <el-popover                                            placement="bottom"                                            title="折扣卡"                                            width="200"                                            trigger="click"                                            v-model="visible"                                    >                                        <div >                                            <div  class="card-view text-hov hov" v-for='(item,index) in memberCardList' @click="chooseMemberCard(index)">                                                {{item.name}}<i class="text-red"> 余额：{{item.amount}}</i>                                            </div>                                        </div>                                        <small slot="reference"> <a class="text-green text-hov" >[重新选择]</a></small>                                    </el-popover>                                </h2>                                <p>                                    <span >卡金：<i class="text-red"> {{memberCard.amount}} </i>元</span>  &nbsp;| &nbsp;                                    <span >项目：<i class="text-red"> {{memberCard.projectDiscount}} </i>折</span>   &nbsp;| &nbsp;                                    <span >卖品：<i class="text-red"> {{memberCard.goodDiscount}} </i>折</span>                                </p>                            </div>                            <div v-else>暂未开卡 &nbsp;<a class="text-green text-hov" @click="selectIndex=1">[去开卡]</a></div>                        </div>                    </div>                </div>                <div class="layui-col-md7">                    <div  class="top-links text-right"><a @click="openRight('first')">个人资料</a><a @click="openRight('first')" >卡券信息</a><a @click="openRight('second')">消费记录</a></div>                </div>            </div>            <div class="tabs cashier-tabs">                <a class="tab" :class="selectIndex==index?'active':''" v-for="(item,index) in cashierTabs" @click="selectIndex=index">                    {{item.title}}                </a>            </div>            <div style="padding: 10px;" v-if="selectIndex==0"  class="container-cashier">                <table class="layui-table md-table " >                    <colgroup>                        <col width="5%">                        <col width="15.8%">                        <col width="15.8%">                        <col width="15.8%">                        <col width="15.8%">                        <col width="15.8%">                        <col>                    </colgroup>                    <thead>                    <tr>                        <th>操作</th>                        <th>编号</th>                        <th>项目/卖品</th>                        <th>单价</th>                        <th>折扣</th>                        <th>实际售价</th>                        <th>服务人员</th>                    </tr>                    </thead>                    <tbody>                    <tr v-for="(productForm,index) in productFormList" >                        <td><el-button type="danger" size="mini" icon="el-icon-delete" circle @click=" delProduct(index);"></el-button></td>                        <td><input type="text" v-model="productForm.productNo"  @focus="seletDropdown($event,'protop','proleft','proshow',index)" @blur="blurDropdown('proshow')" placeholder="选择商品"></td>                        <td><input type="text" v-model="productForm.name" readonly placeholder="项目/卖品" ></td>                        <td><input type="text" v-model="productForm.amount"  oninput="app.clearNoNum(this)" placeholder="原价"></td>                        <td><input type="text" v-model="productForm.discount"  placeholder="折扣"></td>                        <td><input type="text" :value="getRealAmount(productForm,productForm.amount,productForm.discount)"  oninput="app.clearNoNum(this)" placeholder="实际售价"></td>                        <td><input type="text" v-model="productForm.techName"  placeholder="选择服务人员" @focus="seletDropdown($event,'techtop1','techleft1','techshow1',index)" @blur="blurDropdown('techshow1')"></td>                    </tr>                    </tbody>                </table>                <button type="button" class="layui-btn layui-btn-normal" @click="addProductForm"  @mouseleave="clearTimeout(addtimer)" style="margin-top: 15px;" >添加一行( F6 )</button>                <table class="layui-table pay-table"   style="margin-top: 20px;">                    <colgroup>                        <col width="10%">                        <col>                    </colgroup>                    <tbody>                    <tr>                        <td >应收金额</td>                        <td class="text-orange" style="font-weight: bold;">￥                            <span v-if="productFormList[0].amount">{{app.getFloatStr(getTotalAmount)}}</span>                            <span v-else>0.00</span>                        </td>                    </tr>                    <tr v-for="(pay,index) in productPay">                        <td >{{pay.payName}}</td>                        <td v-if="index==0">                            <el-input  placeholder="请输入金额" v-model="pay.amount"  :key="index" :disabled="JSON.stringify(memberCard)=='{}'"  @input="clearNoNum(pay.amount,index,'productPay')">                                <template slot="append">元</template>                            </el-input>                            <template  v-if="memberCard.amount">&nbsp; 剩余 <span class="text-red">{{app.Subtr(memberCard.amount,pay.amount)}}</span> 元</template>                        </td>                        <td v-else>                            <el-input placeholder="请输入金额" v-model="pay.amount" :key="index"  :disabled="pay.hide"  @input="clearNoNum(pay.amount,index,'productPay')">                                <template slot="append">元</template>                            </el-input>                        </td>                    </tr>                    </tbody>                </table>                <div style="padding: 10px;  ">                    <button type="button" class="layui-btn layui-btn-lg btn-color" @click="productSubmit">结算</button>                    <el-checkbox v-model="printchecked" style="margin-left: 20px;">打印小票</el-checkbox>                </div>            </div>        </div>        <!-- 开卡 -->        <div v-if="selectIndex==1" class="container-cashier">            <div style="padding: 10px;">                <table class="layui-table md-table" >                    <colgroup>                        <col width="16.6%">                        <col width="16.6%">                        <col width="16.6%">                        <col width="16.6%">                        <col width="16.6%">                        <col>                    </colgroup>                    <thead>                    <tr>                        <th>卡种</th>                        <th>开卡金额</th>                        <th>赠送金额</th>                        <th>商品折扣</th>                        <th>项目折扣</th>                        <th>服务人员</th>                    </tr>                    </thead>                    <tbody>                    <tr>                        <td><input type="text" v-model="cardForm.name"  @focus="seletDropdown($event,'cardtop','cardleft','cardshow')" @blur="blurDropdown('cardshow')" placeholder="选择卡项"></td>                        <td><input type="text" v-model="cardForm.amount"  oninput="app.clearNoNum(this)" placeholder="开卡金额"></td>                        <td><input type="text" v-model="cardForm.giveAmount"  oninput="app.clearNoNum(this)" placeholder="赠送金额"></td>                        <td><input type="text" v-model="cardForm.projectDiscount" oninput="app.clearNoNum(this)"  placeholder="项目折扣"></td>                        <td><input type="text" v-model="cardForm.goodDiscount" oninput="app.clearNoNum(this)"  placeholder="商品折扣"></td>                        <td><input type="text" v-model="cardForm.techName"  placeholder="选择服务人员" @focus="seletDropdown($event,'techtop2','techleft2','techshow2')" @blur="blurDropdown('techshow2')"></td>                    </tr>                    </tbody>                </table>                <table class="layui-table pay-table"   style="margin-top: 20px;">                    <colgroup>                        <col width="10%">                        <col>                    </colgroup>                    <tbody>                    <tr>                        <td >应收金额</td>                        <td class="text-orange" style="font-weight: bold;">￥                            <span v-if="cardForm.amount">{{app.getFloatStr(getBuildCardAmout)}}</span>                            <span v-else>0.00</span>                        </td>                    </tr>                    <tr v-for="(pay,index) in cardPay">                        <td >{{pay.payName}}</td>                        <td>                            <el-input placeholder="请输入金额" v-model="pay.amount" @input="clearNoNum(pay.amount,index,'cardPay')">                                <template slot="append">元</template>                            </el-input>                        </td>                    </tr>                    </tbody>                </table>                <div style="padding: 10px;  ">                    <button type="button" class="layui-btn layui-btn-lg btn-color" @click="cardSubmit">结算</button>                    <button type="button" class="layui-btn layui-btn-normal layui-btn-lg" @click="cardSubmit('product')">结算并收银</button>                </div>            </div>        </div>        <!-- 续卡 -->        <div v-if="selectIndex==2" class="container-cashier">            <div style="padding: 10px;">                <table class="layui-table md-table" >                    <colgroup>                        <col width="25%">                        <col width="25%">                        <col width="25%">                        <col>                    </colgroup>                    <thead>                    <tr>                        <th>卡种</th>                        <th>充值金额</th>                        <th>赠送金额</th>                        <th>服务人员</th>                    </tr>                    </thead>                    <tbody>                    <tr>                        <td><input type="text" v-model="chargedForm.name"  readonly></td>                        <td><input type="text" v-model="chargedForm.amount"  oninput="app.clearNoNum(this)" placeholder="充值金额"></td>                        <td><input type="text" v-model="chargedForm.giveAmount"  oninput="app.clearNoNum(this)" placeholder="赠送金额"></td>                        <td><input type="text" v-model="chargedForm.techName"  placeholder="选择服务人员" @focus="seletDropdown($event,'techtop3','techleft3','techshow3')" @blur="blurDropdown('techshow3')"></td>                    </tr>                    </tbody>                </table>                <table class="layui-table pay-table"   style="margin-top: 20px;">                    <colgroup>                        <col width="10%">                        <col>                    </colgroup>                    <tbody>                    <tr>                        <td >应收金额</td>                        <td class="text-orange" style="font-weight: bold;">￥                            <span v-if="chargedForm.amount">{{app.getFloatStr(getChargedAmout)}}</span>                            <span v-else>0.00</span>                        </td>                    </tr>                    <tr v-for="(pay,index) in chargedPay">                        <td >{{pay.payName}}</td>                        <td>                            <el-input placeholder="请输入金额" v-model="pay.amount" @input="clearNoNum(pay.amount,index,'chargedPay')">                                <template slot="append">元</template>                            </el-input>                        </td>                    </tr>                    </tbody>                </table>                <div style="padding: 10px;  ">                    <button type="button" class="layui-btn layui-btn-lg btn-color" @click="chargedSubmit">结算</button>                    <button type="button" class="layui-btn layui-btn-normal layui-btn-lg" @click="chargedSubmit('product')">结算并收银</button>                </div>            </div>        </div>        <!--商品项目弹出层-->        <div  class="md-filter-dropdown dropdown-project" :style='{top:protop+"px",left:proleft+"px",display:proshow?"block":"none"}' style=" left: 50px; width: 70%;padding: 15px;">            <div class="fd-arrow" style="left: 92.5px;"></div>            <div style="font-size: 16px;font-weight: bold;" v-if="JSON.stringify(products['project'])!='{}'">                项目:            </div>            <ul>                <li v-for="(value,key) in products['project']" >                    <div class="title">                        <span>{{key}}：</span>                    </div>                    <div>                        <div class="item" v-for="item in value" @mousedown="chooseProduct(item,'project')">                            <i>[{{item.productNo}}]</i>{{item.name}}<span class="text-green">&nbsp;{{item.amount}}元</span><span class="text-red">(会员价：{{item.memberAmount}})</span>                        </div>                    </div>                </li>            </ul>            <div style="font-size: 16px;font-weight: bold;" v-if="JSON.stringify(products['product'])!='{}'" >                卖品:            </div>            <ul>                <li v-for="(value,key) in products['product']" v-if="value.length>0">                    <div class="title">                        <span>{{key}}：</span>                    </div>                    <div>                        <div class="item" v-for="item in value" @mousedown="chooseProduct(item,'product')" style="width: 160px;">                            <i>[{{item.productNo}}]</i>{{item.name}}<span class="text-green">&nbsp;{{item.amount}}元</span><span class="text-red">(会员价：{{item.memberAmount}}&nbsp;&nbsp; 库存：{{item.count}})</span>                        </div>                    </div>                </li>            </ul>        </div>        <!--卡项弹出层-->        <div  class="md-filter-dropdown dropdown-project" :style='{top:cardtop+"px",left:cardleft+"px",display:cardshow?"block":"none"}' style=" left: 50px; width: 70%;">            <div class="fd-arrow" style="left: 92.5px;"></div>            <ul>                <li >                    <div class="title">                        <span>折扣卡：</span>                    </div>                    <div>                        <div class="item" v-for="item in cardList" @mousedown="chooseCard(item)">                            <i>[{{item.no}}]</i>{{item.name}}                        </div>                    </div>                </li>            </ul>        </div>        <!--技师弹出层-->        <div  class="md-filter-dropdown dropdown-project" :style='{top:techtop1+"px",left:(techleft1-340)+"px",display:techshow1?"block":"none"}' style=" width: 33%;">            <div class="fd-arrow" style="left: 430px;"></div>            <ul>                <li >                    <div class="title">                        <span>服务人员：</span>                    </div>                    <div>                        <div class="item" v-for="item in techList" @mousedown="chooseTech(item,'product')">                            <i>[{{item.userName}}]</i>{{item.realName}}                        </div>                    </div>                </li>            </ul>        </div>        <!--技师弹出层-->        <div  class="md-filter-dropdown dropdown-project" :style='{top:techtop2+"px",left:(techleft2-320)+"px",display:techshow2?"block":"none"}' style=" width: 33%;">            <div class="fd-arrow" style="left: 410px;"></div>            <ul>                <li >                    <div class="title">                        <span>服务人员：</span>                    </div>                    <div>                        <div class="item" v-for="item in techList" @mousedown="chooseTech(item,'card')">                            <i>[{{item.userName}}]</i>{{item.realName}}                        </div>                    </div>                </li>            </ul>        </div>        <!--技师弹出层-->        <div  class="md-filter-dropdown dropdown-project" :style='{top:techtop3+"px",left:(techleft3-200)+"px",display:techshow3?"block":"none"}' style=" width: 33%;">            <div class="fd-arrow" style="left: 290px;"></div>            <ul>                <li >                    <div class="title">                        <span>服务人员：</span>                    </div>                    <div>                        <div class="item" v-for="item in techList" @mousedown="chooseTech(item,'charged')">                            <i>[{{item.userName}}]</i>{{item.realName}}                        </div>                    </div>                </li>            </ul>        </div>    </div></div></div><script>    function print(type){        var LODOP=getLodop();        LODOP.PRINT_INIT("测试打印");               //首先一个初始化语句        LODOP.SET_PRINT_PAGESIZE(3, "58mm","10mm","CreateCustomPage");        LODOP.SET_PRINT_STYLE("FontSize", 13); //字体大小        LODOP.ADD_PRINT_TEXT(20,52,148,20,"舍艺修脚");//然后多个ADD语句及SET语句        LODOP.SET_PRINT_STYLE("FontSize", 11); //字体大小        LODOP.ADD_PRINT_TEXT(45,50,150,20,"会员消费单");//然后多个ADD语句及SET语句        LODOP.SET_PRINT_STYLE("FontSize", 8); //字体大小        LODOP.ADD_PRINT_TEXT(60,5,250,20,"--------------------------------");//然后多个ADD语句及SET语句        //循环体距离顶部的距离        var topPosition = 90;        var articleSize = 0;        var linehight = 0;        if(type==1){            LODOP.ADD_PRINT_TEXT(85,5,180,20,"消费类型："+"项目/卖品");//然后多个ADD语句及SET语句             articleSize = 0;             linehight = 60;            for(let good of vm.productFormList){                articleSize++;                console.log(good);                LODOP.ADD_PRINT_TEXT(topPosition+(articleSize*linehight)-40,5,180,20,"项目："+good.name);//然后多个A                // DD语句及SET语句                LODOP.ADD_PRINT_TEXT(topPosition+(articleSize*linehight)-20,5,180,20,"价格："+good.amount);//然后多个ADD语句及SET语句                if(good.discount>0){                    LODOP.ADD_PRINT_TEXT(topPosition+(articleSize*linehight)-20,70,180,20,"折扣："+good.discount);//然后多个ADD语句及SET语句                }                LODOP.ADD_PRINT_TEXT(topPosition+(articleSize*linehight),5,180,20,"实付："+good.realAmount);//然后多个ADD语句及SET语句            }        }        var downPosition = topPosition+(articleSize*linehight);        LODOP.ADD_PRINT_TEXT(downPosition+=20,5,180,20,"总价："+app.getFloatStr(vm.getTotalAmount));//然后多个ADD语句及SET语句        LODOP.ADD_PRINT_TEXT(downPosition+=20,5,180,20,"付款方式-------------------");        for(let productPay of vm.productPay) {            if(productPay.amount>0){                LODOP.ADD_PRINT_TEXT(downPosition+=20,5,220,20,"付款方式："+productPay.payName);                LODOP.ADD_PRINT_TEXT(downPosition+=20,5,220,20,"付款金额："+productPay.amount);            }        }        LODOP.SET_PRINT_STYLE("FontSize", 8); //字体大小        if(app.isNotEmpty(vm.memberCard.amount!=undefined)){            LODOP.ADD_PRINT_TEXT(downPosition+=20,5,220,20,"会员卡余额："+vm.memberCard.amount);        }        LODOP.ADD_PRINT_TEXT(downPosition+=20,5,220,20,"消费时间："+app.getCurentTime());        LODOP.ADD_PRINT_TEXT(downPosition+=20,5,250,20,"--------------------------------");//然后多个ADD语句及SET语句        LODOP.ADD_PRINT_TEXT(downPosition+=20,50,250,20,"祝您生活愉快");//然后多个ADD语句及SET语句        LODOP.SET_PRINT_STYLEA(0,"Stretch",2);//按原图比例(不变形)缩放模式        // LODOP.PREVIEW();//打印预览        LODOP.PRINT();    }    //搜索框回车事件    $(document).on('keydown', function (event) {        if (event.keyCode == 113) {            vm.selectIndex = '0'; return false;        }        if (event.keyCode == 114) {            vm.selectIndex = '1'; return false;        }        if (event.keyCode == 115) {            vm.selectIndex = '2'; return false;        }        if (event.keyCode == 117) {            vm.addProductForm(); return false;        }    });    var productPayCopy = '';    var cardPayCopy = '';    var chargedPayCopy = '';    var iframe =  $("#iframe1", window.parent.document);    //创建定时器    var timer;    var addtimer;    var vm = new Vue({        el: '#app',        data(){            return{                printchecked:true,                loginUser:'',                visible:false,                selectIndex:'0',                cashierTabs:[                    {title:'综合收银 ( F2 )'}, {title:'开卡 ( F3 )'} ,{title:'续卡充值 ( F4 )'}                ],                //联想输入                queryString:'',                //联想输入结果                result:{list:[]},                //当前选择的会员                member:{},                //member:{ "id": "40b7c5b06f13841dc15a20878418f04a", "name": "王旭磊", "sex": "1", "birthday": null, "phoneNumber": "13837520190", "address": "", "comeFrom": "6bf2f9bf0e35e5578ddecc7f2d763ed1", "deptId": "24c43877d7cc4e1a4b7957a4324843a3", "inviter": "", "memberStatus": "", "remark": "", "createTime": "2020-05-13 15:13:49", "avatar": "", "inviterId": "", "userId": null, "smsAlert": "on", "openId": "" },                //会员拥有的卡列表                memberCardList:[],                memberCard:{},                //商品集合                productFormList:[                    {productNo:'',id:'',name:'',amount:'',techId:'',techName:'',discount:'',realAmount:''}],                productIndex:0,                products:{},                protop:'',                proleft:'',                proshow:false,                //技师弹窗距离顶部的位置                techtop1:0,                techleft1:0,                //显示技师弹窗                techshow1:false,                techtop2:0,                techleft2:0,                //显示技师弹窗                techshow2:false,                techtop3:0,                techleft3:0,                //显示技师弹窗                techshow3:false,                //技师弹窗距离顶部的位置                //技师列表                techList:[],                //卡项弹窗距离顶部的位置                cardtop:0,                cardleft:0,                //显示card弹窗                cardshow:false,                //卡项列表                cardList:[],                //开卡form                cardForm:{id:'',name:'',amount:'',giveAmount:'',goodDiscount:'',projectDiscount:'',techName:'',techId:''},                //支付方式                productPay:[                    {payName:'卡金',amount:'',payType:0},                    {payName:'现金',amount:'',payType:1},                    {payName:'银联',amount:'',payType:2},                    {payName:'支付宝支付',amount:'',payType:3},                    {payName:'微信支付',amount:'',payType:4},                    {payName:'其他',amount:'',payType:5},                    {payName:'优惠',amount:'',payType:6},                ],                //开卡支付方式                cardPay:[                    {payName:'现金',amount:'',payType:1},                    {payName:'银联',amount:'',payType:2},                    {payName:'支付宝支付',amount:'',payType:3},                    {payName:'微信支付',amount:'',payType:4},                    {payName:'其他',amount:'',payType:5},                    {payName:'优惠',amount:'',payType:6},                ],                chargedForm:{id:'',name:'',amount:'',giveAmount:'',techName:'',techId:'',cardAmount:''},                chargedPay:[                    {payName:'现金',amount:'',payType:1},                    {payName:'银联',amount:'',payType:2},                    {payName:'支付宝支付',amount:'',payType:3},                    {payName:'微信支付',amount:'',payType:4},                    {payName:'其他',amount:'',payType:5},                    {payName:'优惠',amount:'',payType:6},                ]            }        },        computed:{            getTotalAmount(){                var totalAmount = 0;                if(vm.productFormList.length>0&&vm.productFormList!=undefined){                    for(let item of vm.productFormList){                        var realAmount = item.realAmount;                        if(realAmount!=undefined){                            totalAmount = app.accAdd(totalAmount,realAmount);                        }                    }                    if(vm.memberCard.amount!=undefined){                        if(vm.memberCard.amount>totalAmount){                            if(totalAmount>0){                                vm.productPay[0].amount = totalAmount;                                for(var i=1;i<vm.productPay.length;i++){                                    vm.productPay[i].hide = true;                                    vm.productPay[i].amount = '';                                }                            }                        }else{                            for(var i=1;i<vm.productPay.length;i++){                                vm.productPay[i].hide = false;                            }                            vm.productPay[0].amount = vm.memberCard.amount;                            vm.productPay[1].amount = app.Subtr(totalAmount,vm.memberCard.amount);                        }                    }else{                        if(totalAmount>0){                            vm.productPay[1].amount = totalAmount;                        }                    }                }                return Number(totalAmount);            },            getBuildCardAmout(){                var totalAmount = 0;                if(app.isNotEmpty(vm.cardForm.amount)){                    totalAmount = vm.cardForm.amount;                }                if(totalAmount>0){                    vm.cardPay[0].amount = totalAmount;                }                return totalAmount;            },            getChargedAmout(){                var totalAmount = 0;                if(app.isNotEmpty(vm.chargedForm.amount)){                    totalAmount = vm.chargedForm.amount;                }                if(totalAmount>0){                    vm.chargedPay[0].amount = totalAmount;                }                return totalAmount;            }        },        methods: {            getRealAmount(productForm,amount,discount){                if(app.isEmpty(amount)){                    return ;                }                var realAmount = app.accMul(amount,app.accMul(discount,0.1))                productForm.realAmount = realAmount;                return realAmount            },            openRight(activeName){                top.layer.open({                    type: 2                    ,content:'/admin/cashier/member_edit?id='+vm.member.id                    ,anim: -1                    ,title: false                    ,closeBtn: false                    ,offset: 'r'                    ,shade: 0.1                    ,shadeClose: true                    ,skin: 'layui-anim layui-anim-rl layui-layer-adminRight'                    ,area:['61%','100%'],                    success: function(layero, index){                        var iframeWin = layero.find('iframe')[0].contentWindow;                        if(activeName){                            console.log(iframeWin.vm.activeName = activeName)                        }                    }                })            },            productSubmit(){                var flag = app.ArrayObjIsNotEmpty(vm.productFormList);                if(!flag){                    app.error("请完善表单内容~");                    return;                }                var pay = new Array();                for (let i of vm.productPay){                    if(i.amount>0){                        pay.push(i);                    }                }                var data = {                    user:JSON.stringify(vm.member),                    productFormList:JSON.stringify(vm.productFormList),                    pay:JSON.stringify(pay),                    sellAmount:vm.getTotalAmount,                    memberCard:JSON.stringify(vm.memberCard)                }                request.post("/admin/cashier/productSubmit",data).then(res=>{                    app.success("结算成功！");                    vm.getMemberCardList().then(res=>{                        if(vm.printchecked){                            print(1);                        }                        vm.resetProductForm();                    })                    $(window.parent.document).find('html,body').animate({scrollTop:'0px'},'100')                })            },            delProduct(index){                if(vm.productFormList.length==1){                    app.error("不能再删除了~");                    return;                }                vm.productFormList.splice(index,1);            },            addProductForm(){                var len =  vm.productFormList.length;                if(app.isEmpty(vm.productFormList[len-1].productNo)){                    app.error("请完善上一行数据~");                    return ;                }                vm.productFormList.push({});                iframe.height(iframe.height()+100);            },            //得到smart联想输入的值            getItem (data){                vm.member = data;            },            search(data){                vm.queryString = data            },            getMemberCardList(){              return request.fetch("/admin/member/getMemberCardList",{memberId:vm.member.id}).then(res=>{                    vm.memberCardList = res                    if(vm.memberCardList.length>0){                        vm.memberCard = vm.memberCardList[0];                        Vue.set(vm.chargedForm,"id",vm.memberCard.id);                        Vue.set(vm.chargedForm,"name",vm.memberCard.name);                        Vue.set(vm.chargedForm,"amount",vm.memberCard.buildCardAmount                        );                    }else{                        vm.memberCard = {};                    }                })            },            //打开卡项菜单            seletDropdown(e,top,left,show,index){                vm[top] =  $(e.target).offset().top +30;                vm[left] = $(e.target).offset().left;                vm[show] = true;                if(index!=undefined){                    vm.productIndex = index;                }            },            //关闭卡项菜单            blurDropdown(show){                vm[show] = false;            },            //选择卡项            chooseCard(item){                item.buildCardAmount = item.amount;                vm.cardForm = JSON.parse(JSON.stringify(item));            },            chooseTech(item,type){                if(type=='product'){                    vm.productFormList[vm.productIndex].techId = item.userId;                    vm.productFormList[vm.productIndex].techName = item.realName;                }else if(type=='card'){                    vm.cardForm.techId = item.userId;                    vm.cardForm.techName = item.realName;                }else if(type=='charged'){                    vm.chargedForm.techId = item.userId;                    vm.chargedForm.techName = item.realName;                }            },            //选择会员用哪张卡            chooseMemberCard(index){                vm.memberCard = vm.memberCardList[index];                Vue.set(vm.chargedForm,"id", vm.memberCard.id);                Vue.set(vm.chargedForm,"name", vm.memberCard.name);                vm.visible = false;            },            chooseProduct(item,type){                Vue.set(vm.productFormList[vm.productIndex],'productNo',item.productNo);                Vue.set(vm.productFormList[vm.productIndex],'id',item.id);                Vue.set(vm.productFormList[vm.productIndex],'name',item.name);                Vue.set(vm.productFormList[vm.productIndex],'pushMoney',item.pushMoney);                if(vm.memberCard.id){                    Vue.set(vm.productFormList[vm.productIndex],'amount',item.memberAmount);                }else{                    Vue.set(vm.productFormList[vm.productIndex],'amount',item.amount);                }                Vue.set(vm.productFormList[vm.productIndex],'techId','');                Vue.set(vm.productFormList[vm.productIndex],'techName','');                if(type=='project'){                    var projectDiscount = vm.memberCard.projectDiscount;                    if(projectDiscount!=undefined){                        Vue.set(vm.productFormList[vm.productIndex],'discount',projectDiscount);                    }else{                        Vue.set(vm.productFormList[vm.productIndex],'discount',10);                    }                    Vue.set(vm.productFormList[vm.productIndex],'productType',1);                }else if(type=='product'){                    var goodDiscount = vm.memberCard.goodDiscount;                    if(goodDiscount!=undefined){                        Vue.set(vm.productFormList[vm.productIndex],'discount',goodDiscount);                    }else{                        Vue.set(vm.productFormList[vm.productIndex],'discount',10);                    }                    Vue.set(vm.productFormList[vm.productIndex],'productType',2);                }            },            resetProductForm(){                for(let index in vm.productFormList){                    Vue.set(vm.productFormList[index],'productNo','');                    Vue.set(vm.productFormList[index],'id','');                    Vue.set(vm.productFormList[index],'name','');                    Vue.set(vm.productFormList[index],'amount','');                    Vue.set(vm.productFormList[index],'techId','');                    Vue.set(vm.productFormList[index],'techName','');                    Vue.set(vm.productFormList[index],'discount','');                    Vue.set(vm.productFormList[index],'realAmount','');                }                vm.productFormList = vm.productFormList.splice(0,1);                for(let index in  vm.productPay){                    Vue.set(vm.productPay[index],'amount','');                    Vue.set(vm.productPay[index],'hide',false);                }            },            resetCardForm(){                Vue.set(vm.cardForm,'id','');                Vue.set(vm.cardForm,'name','');                Vue.set(vm.cardForm,'amount','');                Vue.set(vm.cardForm,'giveAmount','');                Vue.set(vm.cardForm,'goodDiscount','');                Vue.set(vm.cardForm,'projectDiscount','');                Vue.set(vm.cardForm,'techName','');                Vue.set(vm.cardForm,'techId','');                for(let index in  vm.cardPay){                    Vue.set(vm.cardPay[index],'amount','');                }            },            resetChargedForm(){                Vue.set(vm.chargedForm,'id','');                Vue.set(vm.chargedForm,'name','');                Vue.set(vm.chargedForm,'amount','');                Vue.set(vm.chargedForm,'giveAmount','');                Vue.set(vm.chargedForm,'techName','');                Vue.set(vm.chargedForm,'techId','');                for(let index in  vm.chargedPay){                    Vue.set(vm.chargedPay[index],'amount','');                }            },            async onload(){                vm.cardList = await api.getCardList();                vm.techList = await api.getTechnicians();                vm.products = await request.fetch("/admin/product/getProduct");                vm.loginUser = await api.getLoginUser();            },            clearNoNum:function(obj,index,pay) {                obj= obj.replace(/[^\d.]/g, "")                    .replace(/^0\d+|^\./g, "")                    .replace(/\.{2,}/g, ".")                    .replace(".", "$#$")                    .replace(/\./g, "")                    .replace("$#$", ".")                    .replace(/^(\d+)\.(\d\d).*$/, "$1.$2");                if(pay=='productPay'){                    vm.productPay[index].amount = obj                }else if(pay=='cardPay'){                    vm.cardPay[index].amount = obj                }else if(pay=='chargedPay'){                    vm.chargedPay[index].amount = obj                }            },            cardSubmit(type){                if(app.isEmpty(vm.cardForm.techName)){                    app.error("请选择服务人员！"); return;                }                var pay = new Array();                for (let i of vm.cardPay){                    if(i.amount>0){                        pay.push(i);                    }                }                var data = {                    user:JSON.stringify(vm.member),                    card:JSON.stringify(vm.cardForm),                    pay:JSON.stringify(pay)                }                request.post("/admin/cashier/buildCard",data).then(res=>{                    app.success("开卡成功！")                    vm.resetCardForm();                    vm.getMemberCardList();                    if(type=='product'){                        vm.selectIndex = 0;                    }                    $(window.parent.document).find('html,body').animate({scrollTop:'0px'},'100')                })            },            chargedSubmit(type){                if(app.isEmpty(vm.chargedForm.techName)){                    app.error("请选择服务人员！"); return;                }                var pay = new Array();                for (let i of vm.chargedPay){                    if(i.amount>0){                        pay.push(i);                    }                }                var data = {                    user:JSON.stringify(vm.member),                    card:JSON.stringify(vm.chargedForm),                    pay:JSON.stringify(pay)                }                request.post("/admin/cashier/chargedCard",data).then(res=>{                    app.success("续卡成功！")                    vm.resetChargedForm();                    vm.getMemberCardList();                    if(type=='product'){                        vm.selectIndex = 0;                    }                    $(window.parent.document).find('html,body').animate({scrollTop:'0px'},'100')                })            }        },        mounted:async function() {            vm = this;            vm.onload();            form.render();        },        updated: function () {            form.render();        },        watch:{            member(newval){                vm.resetProductForm();                vm.resetCardForm();                vm.getMemberCardList();                iframe.height(1150);            },            selectIndex(newval){                setTimeout(function () {                    iframe.height(document.body.scrollHeight+100);                },50)            },            productPay:{                handler:function(newValue){                    //订单需要支付的钱                    var needPay =  Number(vm.getTotalAmount);                    if(needPay<=0){                        return;                    }                    //ui显示的金额                    var realPay = 0;                    //ui显示的全部金额相加                    for(let pay of newValue){                        let amount = pay.amount;                        realPay = app.accAdd(realPay,amount);                    }                    //声明一个最后一个输入的下标                    var nowChoose;                    //用户改变支付方式时候才走的逻辑                    if(productPayCopy){                        //获取用户改变的哪个支付方式                        for(let i=0;i<newValue.length;i++){                            if(productPayCopy[i].amount!==newValue[i].amount){                                nowChoose = i;                                break;                            }                        }                        console.log(vm.memberCard.amount!=undefined)                        if(vm.memberCard.amount!=undefined){                            //如果是卡金不够支付                            if(vm.productPay[0].amount>=vm.memberCard.amount){                                vm.productPay[0].amount = vm.memberCard.amount;                            }else{                                vm.productPay[0].amount = needPay;                            }                            needPay = app.Subtr(needPay,vm.memberCard.amount);                            realPay = app.Subtr(realPay,vm.memberCard.amount)                        }                        //如果实际金额小于应付金额                        if(realPay<needPay){                            //计算出来少了多少钱                            var shortfall =  app.Subtr(needPay,realPay);                            //从上到下，赋值给非用户最后输入的逻辑                            for(let i=1;i<vm.productPay.length;i++){                                if(i!=nowChoose){                                    vm.productPay[i].amount = app.accAdd(vm.productPay[i].amount,shortfall);                                    break;                                }                            }                        }else  if(realPay>needPay){                            //当前用输入框输入的金额                            var nowChooseAmount = vm.productPay[nowChoose].amount;                            //单个输入框大于needPay的时候                            if(nowChooseAmount>needPay){                                vm.productPay[nowChoose].amount = needPay;                                for(let i=1;i<vm.productPay.length;i++){                                    if(i!=nowChoose){                                        vm.productPay[i].amount = '';                                    }                                }                            }else {                                //计算出来多了多少钱                                var duo  = app.Subtr(realPay,needPay);                                for(let i=1;i<vm.productPay.length;i++){                                    if(vm.productPay[i].amount>=duo){                                        if(i!=nowChoose) {                                            vm.productPay[i].amount = app.Subtr(vm.productPay[i].amount, duo);                                            if(vm.productPay[i].amount==0){                                                vm.productPay[i].amount='';                                            }                                            break;                                        }                                    }else {                                        if(i!=nowChoose) {                                            duo = app.Subtr(duo, vm.productPay[i].amount);                                            vm.productPay[i].amount = '';                                        }                                    }                                }                            }                        }                    }                    productPayCopy = JSON.parse(JSON.stringify(newValue));                },                deep:true, //深度监听            },            cardPay:{                handler:function(newValue){                    //订单需要支付的钱                    var needPay = Number(vm.getBuildCardAmout);                    //ui显示的金额                    var realPay = 0;                    //ui显示的全部金额相加                    for(let pay of newValue){                        let amount = pay.amount;                        realPay = app.accAdd(realPay,amount);                    }                    //声明一个最后一个输入的下标                    var nowChoose;                    //用户改变支付方式时候才走的逻辑                    if(cardPayCopy){                        //获取用户改变的哪个支付方式                        for(let i=0;i<newValue.length;i++){                            if(cardPayCopy[i].amount!==newValue[i].amount){                                nowChoose = i;                                break;                            }                        }                        //如果实际金额小于应付金额                        if(realPay<needPay){                            //计算出来少了多少钱                            var shortfall =  app.Subtr(needPay,realPay);                            //从上到下，赋值给非用户最后输入的逻辑                            for(let i=0;i<vm.cardPay.length;i++){                                if(i!=nowChoose){                                    vm.cardPay[i].amount = app.accAdd(vm.cardPay[i].amount,shortfall);                                    break;                                }                            }                        }else  if(realPay>needPay){                            //当前用输入框输入的金额                            var nowChooseAmount = vm.cardPay[nowChoose].amount;                            //单个输入框大于needPay的时候                            if(nowChooseAmount>needPay){                                vm.cardPay[nowChoose].amount = needPay;                                for(let i=0;i<vm.cardPay.length;i++){                                    if(i!=nowChoose){                                        vm.cardPay[i].amount = '';                                    }                                }                            }else {                                //计算出来多了多少钱                                var duo  = app.Subtr(realPay,needPay);                                for(let i=0;i<vm.cardPay.length;i++){                                    if(vm.cardPay[i].amount>=duo){                                        if(i!=nowChoose) {                                            vm.cardPay[i].amount = app.Subtr(vm.cardPay[i].amount, duo);                                            if(vm.cardPay[i].amount==0){                                                vm.cardPay[i].amount='';                                            }                                            break;                                        }                                    }else {                                        if(i!=nowChoose) {                                            duo = app.Subtr(duo, vm.cardPay[i].amount);                                            vm.cardPay[i].amount = '';                                        }                                    }                                }                            }                        }                    }                    cardPayCopy = JSON.parse(JSON.stringify(newValue));                },                deep:true, //深度监听            },            chargedPay:{                handler:function(newValue){                    //订单需要支付的钱                    var needPay = Number(vm.getChargedAmout);                    //ui显示的金额                    var realPay = 0;                    //ui显示的全部金额相加                    for(let pay of newValue){                        let amount = pay.amount;                        realPay = app.accAdd(realPay,amount);                    }                    //声明一个最后一个输入的下标                    var nowChoose;                    //用户改变支付方式时候才走的逻辑                    if(chargedPayCopy){                        //获取用户改变的哪个支付方式                        for(let i=0;i<newValue.length;i++){                            if(chargedPayCopy[i].amount!==newValue[i].amount){                                nowChoose = i;                                break;                            }                        }                        //如果实际金额小于应付金额                        if(realPay<needPay){                            //计算出来少了多少钱                            var shortfall =  app.Subtr(needPay,realPay);                            //从上到下，赋值给非用户最后输入的逻辑                            for(let i=0;i<vm.chargedPay.length;i++){                                if(i!=nowChoose){                                    vm.chargedPay[i].amount = app.accAdd(vm.chargedPay[i].amount,shortfall);                                    break;                                }                            }                        }else  if(realPay>needPay){                            //当前用输入框输入的金额                            var nowChooseAmount = vm.chargedPay[nowChoose].amount;                            //单个输入框大于needPay的时候                            if(nowChooseAmount>needPay){                                vm.chargedPay[nowChoose].amount = needPay;                                for(let i=0;i<vm.chargedPay.length;i++){                                    if(i!=nowChoose){                                        vm.chargedPay[i].amount = '';                                    }                                }                            }else {                                //计算出来多了多少钱                                var duo  = app.Subtr(realPay,needPay);                                for(let i=0;i<vm.chargedPay.length;i++){                                    if(vm.chargedPay[i].amount>=duo){                                        if(i!=nowChoose) {                                            vm.chargedPay[i].amount = app.Subtr(vm.chargedPay[i].amount, duo);                                            if(vm.chargedPay[i].amount==0){                                                vm.chargedPay[i].amount='';                                            }                                            break;                                        }                                    }else {                                        if(i!=nowChoose) {                                            duo = app.Subtr(duo, vm.chargedPay[i].amount);                                            vm.chargedPay[i].amount = '';                                        }                                    }                                }                            }                        }                    }                    chargedPayCopy = JSON.parse(JSON.stringify(newValue));                },                deep:true, //深度监听            },            queryString:function (newVal) {                if(newVal){                    //搜索前清除定时器                    clearTimeout(timer);                    timer = setTimeout(function () {                        request.fetch('/admin/member/getMemberList',{                            name:newVal,                            phoneNumber:newVal,                            deptId:vm.loginUser.deptId                        }).then(res=>{                            vm.result.list = res;                        })                    },200)                }            }        }    })</script><% } %>