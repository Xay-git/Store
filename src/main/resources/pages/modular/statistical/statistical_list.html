<% layout("/common/_container.html"){ %><link rel="stylesheet" href="/modular/css/cashier.css" media="all"><div  id="app">    <div class="top_tab" >        <el-menu :default-active="activeIndex" class="el-menu-demo" mode="horizontal" @select="handleSelect" active-text-color="#d81f3e">            <el-menu-item index="1">开卡</el-menu-item>            <el-menu-item index="2">卖品</el-menu-item>            <el-menu-item index="3">员工业绩明细</el-menu-item>        </el-menu>    </div>    <div v-show="activeIndex==1">    <div class="layui-col-md12" style="margin-top: 70px;">        <div class="layui-card">            <div class="layui-card-body">                <div class="layui-form toolbar">                    <div class="layui-form-item">                        <div class="layui-inline">                            <input v-model="condition" class="layui-input" type="text" placeholder="名称"/>                        </div>                        <div class="layui-inline">                            <div class="block">                                <span class="demonstration">日期&nbsp;&nbsp;&nbsp;</span>                                <el-date-picker                                        v-model="value2"                                        type="datetimerange"                                        :picker-options="pickerOptions"                                        range-separator="至"                                        start-placeholder="开始日期"                                        end-placeholder="结束日期"                                        align="right">                                </el-date-picker>                            </div>                        </div>                        <div class="layui-inline">                            <button type="button" @click="tableReload" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索</button>                            <button type="button" @click="tableReload('reset')" class="layui-btn icon-btn" ><i class="layui-icon">&#xe669;</i>重置</button>                            <button type="button" @click="btnAdd" class="layui-btn icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>                        </div>                    </div>                </div>                <table class="layui-table" id="memberTable" lay-filter="memberTable"></table>            </div>        </div>    </div>        <template>            <el-dialog title="详情" width="80%" :visible.sync="dialogTableVisible">                <el-table :data="gridData"  :span-method="arraySpanMethod" >                    <el-table-column property="dateYmd" label="日期"></el-table-column>                    <el-table-column property="dateHms" label="时间"></el-table-column>                    <el-table-column property="selltype" label="操作类型">                        <template slot-scope="scope">                            <el-tag type="success" effect="dark" v-if="scope.row.selltype==1">开卡</el-tag>                            <el-tag type="warning" effect="dark" v-if="scope.row.selltype==2">续卡</el-tag>                        </template>                    </el-table-column>                    <el-table-column property="dateCardUser" label="用户名"></el-table-column>                    <el-table-column property="dateCardAmount" label="金额"></el-table-column>                    <el-table-column property="dateCardGiveAmount" label="赠送金额"></el-table-column>                </el-table>            </el-dialog>        </template>    </div>    <div v-show="activeIndex==2">        <div class="layui-col-md12" style="margin-top: 70px;">            <div class="layui-card">                <div class="layui-card-body">                    <div class="layui-form toolbar">                        <div class="layui-form-item">                            <div class="layui-inline">                                <input v-model="condition1" class="layui-input" type="text" placeholder="名称"/>                            </div>                            <div class="layui-inline">                                <button type="button" @click="tableReload1" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索</button>                                <button type="button" @click="tableReload1('reset')" class="layui-btn icon-btn" ><i class="layui-icon">&#xe669;</i>重置</button>                            </div>                        </div>                    </div>                    <table class="layui-table" id="memberTable1"></table>                </div>            </div>        </div>    </div></div><script>    var initColumn =  [[        {field:'id',title:'',hide:true},        {field:'name', merge: true,title:'卡分类'},        {field:'cardCount', merge: true,title:'开卡数量'},        {field:'cardUserCount', merge: true,title:'开卡人次'},        {field:'cardAmount', merge: true,title:'开卡总额'},        {field:'cardGiveAmount', merge: true,title:'开卡赠送总额'},        {field:'chargedCount', merge: true,title:'续卡数量'},        {field:'chargedAmount', merge: true,title:'续卡总额'},        {field:'chargedGiveAmount', merge: true,title:'续卡赠送总额'},    ]];    var initColumn1 =  [[        {type: 'checkbox', fixed: 'left'},        {field:'id',title:'',hide:true},        {field:'categoryName', merge: true,title:'所属分类'},        {field:'productNo',title:'项目编号'},        {field:'name',title:'名称'},        {field:'amount',title:'零售价'},        {field:'memberAmount',title:'会员价'},        {field:'commonPushMoney',title:'普通技师提成',hide:app.getUrlParam("type")=='2'?true:false},        {field:'highPushMoney',title:'高级技师提成',hide:app.getUrlParam("type")=='2'?true:false},        {field:'topPushMoney',title:'首席技师提成',hide:app.getUrlParam("type")=='2'?true:false},        {field:'pushPercent',title:'提成比例',hide:app.getUrlParam("type")=='1'?true:false},        {field:'unit',title:'单位',hide:app.getUrlParam("type")=='1'?true:false},        {field:'remark',title:'备注'},        {field:'createTime',title:'创建时间'},        {field:'createName',title:'创建人'},    ]];    function openRight(id){        top.layer.open({            type: 2            ,content:'/admin/cashier/member_edit?id='+id            ,anim: -1            ,title: false            ,closeBtn: false            ,offset: 'r'            ,shade: 0.1            ,shadeClose: true            ,skin: 'layui-anim layui-anim-rl layui-layer-adminRight'            ,area:['61%','100%'],            success: function(layero, index){                var iframeWin = layero.find('iframe')[0].contentWindow;            }        })    }    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            card:'',            condition:'',            condition1:'',            loginUser:'',            activeIndex:'1',            pickerOptions: {                shortcuts: [                    {                        text: '今天',                        onClick(picker) {                            const end = new Date();                            const start = new Date(new Date().toLocaleDateString());                            picker.$emit('pick', [start, end]);                        }                    },                    {                        text: '昨天',                        onClick(picker) {                            const end = new Date(new Date().toLocaleDateString());                            const start = new Date(new Date().toLocaleDateString());                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 1);                            picker.$emit('pick', [start, end]);                        }                    }                    ,{                        text: '最近一周',                        onClick(picker) {                            const end = new Date();                            const start = new Date(new Date().toLocaleDateString());                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);                            picker.$emit('pick', [start, end]);                        }                    }, {                        text: '最近一个月',                        onClick(picker) {                            const end = new Date();                            const start = new Date(new Date().toLocaleDateString());                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);                            picker.$emit('pick', [start, end]);                        }                    }, {                        text: '最近三个月',                        onClick(picker) {                            const end = new Date();                            const start = new Date(new Date().toLocaleDateString());                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);                            picker.$emit('pick', [start, end]);                        }                    }]            },            value2: '',            beginTime:'',            endTime:'',            dialogTableVisible: false,            gridData:'',            needMergeArr: ['dateYmd', 'dateHms'], // 有合并项的列            rowMergeArrs: {}, // 包含需要一个或多个合并项信息的对象        },        watch:{            value2:function (newVal) {                vm.beginTime = app.dateFormat(newVal[0],"YYYY-mm-dd HH:MM:SS");                vm.endTime = app.dateFormat(newVal[1],"YYYY-mm-dd HH:MM:SS");            }        },        methods: {            handleSelect(tab, keyPath) {                vm.activeIndex = tab;                if(vm.activeIndex==1){                }else{                    vm.getDelMemberTable();                }            },            btnAdd:function () {                location.href = 'member_edit';            },            tableReload:function (action) {                if(app.isEmpty(vm.beginTime)){                    app.error("请选择日期");                }else{                    vm.getMemberTable();                if(action=='reset'){ vm.condition='' };                var queryData = {                    beginTime:vm.beginTime,                    endTime:vm.endTime,                };                table.reload('memberTable',{                    where: queryData, });                }            },            tableReload1:function (action) {                if(action=='reset'){ vm.condition='' };                var queryData = {                    name:vm.condition,                    phoneNumber:vm.condition,                };                table.reload('memberTable1',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            getMemberTable(){                table.render({                    elem: '#memberTable',                    url: 'getstatisticalCardList',                    height: "full-150",                    cellMinWidth: 100,                    cols: initColumn,                    data:vm.card.data,                });            },            getDelMemberTable(){                table.render({                    elem: '#memberTable1',                    url: '/admin/product/getProductList',                    page: true,                    height: "full-150",                    cellMinWidth: 100,                    cols: initColumn1,                    where:{                        productType:app.getUrlParam("type")                    },                    done: function(res, curr, count){                    }                });            },            arraySpanMethod({ row, column, rowIndex, columnIndex}) {                // 没办法循环判断具体是那一列 所以就只好写了多个if                if (column.property === 'dateYmd') return this.mergeAction('dateYmd', rowIndex, column);            },            mergeAction(val, rowIndex, colData) {                let _row = this.rowMergeArrs[val].rowArr[rowIndex];                let _col = _row > 0 ? 1 : 0;                return [_row, _col];            },            rowMergeHandle(arr, data) {                if (!Array.isArray(arr) && !arr.length) return false;                if (!Array.isArray(data) && !data.length) return false;                let needMerge = {};                arr.forEach(i => {                    needMerge[i] = {                        rowArr: [],                        rowMergeNum: 0                    };                    data.forEach((item, index) => {                        if (index === 0) {                            needMerge[i].rowArr.push(1);                            needMerge[i].rowMergeNum = 0;                        } else {                            if (item[i] === data[index - 1][i]) {                                needMerge[i].rowArr[needMerge[i].rowMergeNum] += 1;                                needMerge[i].rowArr.push(0);                            } else {                                needMerge[i].rowArr.push(1);                                needMerge[i].rowMergeNum = index;                            }                        }                    });                });                return needMerge;            }        },        mounted:async function() {            vm = this;            vm.loginUser = await api.getLoginUser();            table.on('tool(memberTable)', function (obj) {                var event = obj.event;                var data = obj.data;                if (event == 'del') {                    app.confirm("确定删除吗?",function () {                        request.fetch("delMember",{id:data.id}).then(res=>{                            app.success("删除成功！")                            vm.tableReload();                        })                    })                } else if (event == 'edit') {                    location.href = 'member_edit?id='+data.id;                }            });            table.on('row(memberTable)', function(obj){                vm.gridData = obj.data.cardDateDetailsList                vm.dialogTableVisible = true                vm.rowMergeArrs = vm.rowMergeHandle(vm.needMergeArr, vm.gridData); // 处理数据            })            form.render();        },        updated: function () {            form.render();        }    })</script><% } %>