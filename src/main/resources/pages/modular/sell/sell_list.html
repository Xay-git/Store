<% layout("/common/_container.html"){ %><style>    .layui-table-cell {        height: auto !important;    }    .text-red{        color: #d81f3e!important;    }</style><div class="layui-fluid" id="app">    <div class="layui-col-md12">        <div class="layui-card">            <div class="layui-card-body">                <div class="layui-form toolbar">                    <div class="layui-form-item">                        <div class="layui-inline">                            <input v-model="condition" class="layui-input" type="text" placeholder="会员名/手机号"/>                        </div>                        门店&nbsp;&nbsp;&nbsp;                        <div class="layui-inline">                            <el-select  v-model="deptId" >                                <el-option                                        v-for="item in deptList"                                        :key="item.deptId"                                        :label="item.deptName"                                        :value="item.deptId"                                >                                </el-option>                            </el-select>                        </div>                        <div class="layui-inline">                            <div class="block">                                <span class="demonstration">日期&nbsp;&nbsp;&nbsp;</span>                                <el-date-picker                                        v-model="value2"                                        type="datetimerange"                                        :picker-options="pickerOptions"                                        range-separator="至"                                        start-placeholder="开始日期"                                        end-placeholder="结束日期"                                        align="right">                                </el-date-picker>                            </div>                        </div>                        状态&nbsp;&nbsp;&nbsp;                        <div class="layui-inline" >                            <el-select v-model="status">                                <el-option                                        v-for="item in statusList"                                        :key="item.status1"                                        :label="item.name"                                        :value="item.status"                                >                                </el-option>                            </el-select>                        </div>                        <div class="layui-inline">                            <button id="search" type="button" @click="tableReload" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索</button>                            <button type="button" @click="tableReload('reset')" class="layui-btn icon-btn" ><i class="layui-icon">&#xe669;</i>重置</button>                            <button id="btnExp" class="layui-btn icon-btn" @click="btnExp"><i class="layui-icon">&#xe67d;</i>导出</button>                        </div>                    </div>                    <div style="margin-top: 5px;">                        <blockquote class="layui-elem-quote">本次共查询                        <i class="text-red">{{result.total}}</i> 张流水单                            消费合计：                        <i class="text-red">{{result.totalMoney}}</i>                            | 卡扣：                        <i class="text-red">{{result.cardpay}}</i>                            | 条码支付：                        <i class="text-red">{{result.codepay}}</i>                            | 现金：                        <i class="text-red">{{result.cashpay}}</i>                            | 银联：                        <i class="text-red">{{result.ylpay}}</i>                            | 其他：                        <i class="text-red">{{result.otherpay}}</i>                            | 优惠：                        <i class="text-red">{{result.discountpay}}</i>                            | 团购券：                        <i class="text-red">{{result.tuanpay}}</i>                        </blockquote>                    </div>                </div>                <table class="layui-table" id="sellTable" lay-filter="sellTable"></table>            </div>        </div>    </div></div><script type="text/html" id="tableBar">    {{#  if(d.status==1){ }}    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">销单</a>    {{#  }}}</script><script>    var tableResult;    var initColumn =  [[        {type: 'checkbox'},        {field:'id',title:'',hide:true},        {field:'memberName',title:'会员名称',templet(d){            if(d.memberName==''){                return "散客";            }else{                var html = "<a style=\"color: #009688;cursor: pointer;\" onclick=\"openRight('"+d.memberId+"')\" > "+d.memberName+"</a>"                return  html;            }            }},        {field:'phoneNumber',title:'手机号',width:130},        {field:'sellAmount',title:'消费金额',width:90},        {field:'realAmount',title:'实际入账',width:90},        {field:'sellType',title:'消费类型',templet(d){            if(d.sellType==1){                return "开卡";            }            if(d.sellType==2){                return "续卡";            }            if(d.sellType==3){                return "卖品/项目";            }            }},        {title:'销售详情',width:320,templet(d){           var html = '';           for(let item of d.selldetailList){               html += "消费项目:"+item.name+"<br/>"                    +"原价:"+item.amount                    +"&nbsp;|&nbsp;实收:"+item.realAmount                   + "&nbsp;|&nbsp;服务人员:<br/>"               for (let thce of item.selldetailTechList) {                   console.log("1__" + thce.techName)                   html += "" + thce.techName + "<br/>"               }           }           return html;            }},        {title:'支付方式',width:240,templet(d){                var html = '';                for(let item of d.sellpayList){                    html += "支付方式:"+"<span>"+item.payName                        +"&nbsp;|&nbsp;支付金额:"+item.amount+"<br/>"                }                return html;            }},        {field:'status',title:'状态',templet(d){            if(d.status==1){                return '正常'            }else if(d.status==2){                return '<span style="color:red">已销单</span>'            }            },width:70},        {field:'createName',title:'操作人',width:90},        {field:'createTime',title:'操作时间',width:160},        {field:'remark',title:'备注',width:100},        {align: 'center', toolbar: '#tableBar', title: '操作' }    ]];    function openRight(id){        top.layer.open({            type: 2            ,content:'/admin/cashier/member_edit?id='+id            ,anim: -1            ,title: false            ,closeBtn: false            ,offset: 'r'            ,shade: 0.1            ,shadeClose: true            ,skin: 'layui-anim layui-anim-rl layui-layer-adminRight'            ,area:['61%','100%'],            success: function(layero, index){                var iframeWin = layero.find('iframe')[0].contentWindow;            }        })    }    var vm = new Vue({        el: '#app',        data: {            msg: 'Hello World!',            statusList:[{name:'正常',status:1},{name:'销单',status:2}],            deptList:[],            deptId:'',            condition:'',            status:1,            pickerOptions: {                shortcuts: [                    {                        text: '今天',                        onClick(picker) {                            const end = new Date();                            const start = new Date(new Date().toLocaleDateString());                            picker.$emit('pick', [start, end]);                        }                    },                    {                        text: '昨天',                        onClick(picker) {                            const end = new Date(new Date().toLocaleDateString());                            const start = new Date(new Date().toLocaleDateString());                            start.setTime(start.getTime() - 3600 * 1000 * 24 * 1);                            picker.$emit('pick', [start, end]);                        }                    }                 ,{                    text: '最近一周',                    onClick(picker) {                        const end = new Date();                        const start = new Date(new Date().toLocaleDateString());                        start.setTime(start.getTime() - 3600 * 1000 * 24 * 7);                        picker.$emit('pick', [start, end]);                    }                }, {                    text: '最近一个月',                    onClick(picker) {                        const end = new Date();                        const start = new Date(new Date().toLocaleDateString());                        start.setTime(start.getTime() - 3600 * 1000 * 24 * 30);                        picker.$emit('pick', [start, end]);                    }                }, {                    text: '最近三个月',                    onClick(picker) {                        const end = new Date();                        const start = new Date(new Date().toLocaleDateString());                        start.setTime(start.getTime() - 3600 * 1000 * 24 * 90);                        picker.$emit('pick', [start, end]);                    }                }]            },           value2: '',           beginTime:'',           endTime:'',           result:{total:''},           loginUser:'',        },        methods: {            btnAdd:function () {                location.href = 'sell_edit';            },            tableReload:function (action) {                if(action=='reset'){ location.reload() };                // vm.setDefaultDate();                var queryData = {                    memberName:vm.condition,                    deptId:vm.deptId,                    beginTime:vm.beginTime,                    endTime:vm.endTime,                    status:vm.status                };                table.reload('sellTable',{                    where: queryData, page: {                        curr: 1 //重新从第 1 页开始                    }});            },            setDefaultDate(){                const end = new Date();                const start = new Date(new Date().toLocaleDateString());                vm.value2= [start, end];            },            btnExp(){                if(table.cache.sellTable.length === 0){                    app.error("暂无数据");                }else{                    table.exportFile(tableResult.config.id, table.cache.sellTable,'xls'); //data 为该实例中的任意数量的数据                }            }        },        mounted:async function() {            vm = this;            vm.setDefaultDate();            vm.loginUser = await api.getLoginUser();            this.deptList = await api.getDeptList();            this.deptId = vm.loginUser.deptId;            tableResult = table.render({                elem: '#sellTable',                url: 'getSellList',                page: true,                limit:100,                limits:[100,200,500],                height: "full-180",                cellMinWidth: 100,                cols: initColumn,                where:{                    deptId:vm.deptId,                    beginTime:vm.beginTime,                    endTime:vm.endTime,                    status:vm.status                },                done: function(res, curr, count){                    console.log('返回数据的个数'+ count);                    vm.result.total = count;                    //如果是异步请求数据方式，res即为你接口返回的信息。                    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度                    console.log(res);                    var data = res.data;                    var totalMoney = 0 ;                    var cardpay = 0 ;                    var codepay = 0; //1                    var cashpay = 0;  //2                    var ylpay = 0; //3                    var otherpay = 0; //4                    var discountpay = 0; //5                    var tuanpay = 0;                    var cardPay = 0;                    for(let item of data){                        totalMoney = app.accAdd(item.sellAmount,totalMoney);                        var sellpayList = item.sellpayList;                        for(let pay of sellpayList){                            console.log(pay)                            var payType = pay.payType;                            if(payType==0){                                cardpay = app.accAdd(pay.amount,cardpay);                            }else if(payType==1){                                codepay = app.accAdd(pay.amount,codepay);                            }else if(payType==2){                                cashpay = app.accAdd(pay.amount,cashpay);                            }else if(payType==3){                                ylpay = app.accAdd(pay.amount,ylpay);                            }else if(payType==4){                                otherpay = app.accAdd(pay.amount,otherpay);                            }else if(payType==5){                                discountpay = app.accAdd(pay.amount,discountpay);                            }else if(payType==6){                                tuanpay = app.accAdd(pay.amount,tuanpay);                            }                        }                    }                    console.log("合计金额"+totalMoney);                    vm.result.totalMoney = totalMoney;                    vm.result.cardpay = cardpay;                    vm.result.codepay = codepay;                    vm.result.cashpay = cashpay;                    vm.result.ylpay = ylpay;                    vm.result.otherpay = otherpay;                    vm.result.discountpay = discountpay;                    //得到当前页码                    console.log(curr);                    //得到数据总量                    console.log(count);                }            });            table.on('tool(sellTable)', function (obj) {                var event = obj.event;                var data = obj.data;                if (event == 'del') {                    app.confirm("确定要进行销单操作吗?",function () {                        var index = top.layer.confirm();                        top.layer.close(index);                        layer.prompt({                            formType: 2,                            placeholder: '请输入撤销原因',                            title: '输入撤销原因',                        }, function(value, index, elem){                            request.post("delSell",{id:data.id,remark:value}).then(res=>{                                app.success("操作成功！")                                vm.tableReload();                                //充值完直接改变消费页面的余额                                $('.admin-iframe', window.parent.document).each(function () {                                    var href = $(this)[0].contentWindow.location.href;                                    if (href.indexOf('/admin/cashier') > -1) {                                        $(this)[0].contentWindow.location.reload();                                    }                                })                                layer.close(index)                            })                        });                    })                } else if (event == 'edit') {                    location.href = 'sell_edit?id='+data.id;                }            });            form.render();        },        updated: function () {            form.render();        },        watch:{            value2:function (newVal) {                vm.beginTime = app.dateFormat(newVal[0],"YYYY-mm-dd HH:MM:SS");                vm.endTime = app.dateFormat(newVal[1],"YYYY-mm-dd HH:MM:SS");            }        }    })    //搜索框回车事件    $(document).on('keydown', function (event) {        if (event.keyCode == 13) {            $('#search').click();            return false        }    });</script><% } %>